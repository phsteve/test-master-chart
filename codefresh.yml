version: "1.0"
steps:
  SetDependencyYAML:
    image: 'python'
    commands:
      - pip install pyyaml #TODO: build this into the image or do something better
      - python set_branches.py
  UpdateSubcharts:
    image: 'codefresh/cfstep-helm:2.9.1'
    environment:
      - ACTION=auth
      - CHART_NAME=./
      - RELEASE_NAME=master-chart
      - KUBE_CONTEXT=Beta
    commands:
      - export HELM_REPO_ACCESS_TOKEN=$CF_API_KEY
      - export HELM_REPO_AUTH_HEADER="x-access-token"
      - helm repo add codefresh cm://h.cfcr.io/teacherspayteachers/default/
      - helm dep up
      - /opt/bin/release_chart
  InstallChart:
    image: 'codefresh/cfstep-helm:2.9.1'
    environment:
      - CHART_NAME=./
      - RELEASE_NAME=master-chart
      - KUBE_CONTEXT=Beta
      - VALUESFILE_beta='Values.yaml'
